<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZyChat Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { background: #313338; color: #dbdee1; font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; }
        
        /* Discord Context Menu */
        #context-menu {
            position: fixed; z-index: 10000; width: 180px; background: #111214; 
            border-radius: 4px; padding: 6px; display: none; box-shadow: 0 8px 16px rgba(0,0,0,0.24);
        }
        .menu-item { 
            padding: 8px 12px; font-size: 14px; border-radius: 2px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .menu-item:hover { background: #4752c4; color: white; }
        .menu-item.delete:hover { background: #da373c; }

        .msg-item { border-radius: 4px; transition: background 0.1s; }
        .msg-item:hover { background: #2e3035; }
        .editing { background: rgba(250, 166, 26, 0.05) !important; border-left: 2px solid #faa61a; }
        
        #call-pill { 
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000;
            background: #23a559; color: white; padding: 6px 16px; border-radius: 20px;
            font-size: 11px; font-bold; cursor: pointer; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="flex">

    <div id="context-menu" class="glass">
        <div class="menu-item" onclick="startEdit()">Edit Message <span class="opacity-50 text-[10px]">UP</span></div>
        <div class="menu-item delete" onclick="confirmDelete()" style="color: #fa777c;">Delete Message</div>
    </div>

    <div id="call-pill" onclick="maximizeCall()">● VOICE CALL ACTIVE</div>

    <div id="login-page" class="fixed inset-0 z-[5000] bg-[#313338] flex items-center justify-center">
        <div class="w-80 text-center">
            <h1 class="text-3xl font-bold mb-6">ZYCHAT</h1>
            <input id="u-name" type="text" placeholder="Username" class="w-full p-3 bg-[#1e1f22] rounded mb-3 outline-none">
            <input id="u-pass" type="password" placeholder="Password" class="w-full p-3 bg-[#1e1f22] rounded mb-6 outline-none">
            <button onclick="handleLogin()" class="w-full bg-[#5865f2] p-3 rounded font-bold">Log In</button>
        </div>
    </div>

    <div id="chat-page" class="hidden flex-1 flex flex-col">
        <header class="h-12 border-b border-black/20 flex items-center px-4 font-bold shadow-sm"># general</header>
        <div id="msg-container" class="flex-1 overflow-y-auto p-4 space-y-1">
            <div id="msg-box"></div>
        </div>
        <div class="p-4 bg-[#313338]">
            <div class="bg-[#383a40] rounded-lg px-4 py-3">
                <input id="msg-input" type="text" placeholder="Message #general" class="w-full bg-transparent outline-none text-sm">
            </div>
            <div id="edit-info" class="hidden text-[10px] mt-2 text-gray-400">
                Editing message — <span onclick="cancelEdit()" class="text-[#00a8fc] cursor-pointer hover:underline">cancel</span>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://bpsutdwybsatmxuyjzfe.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwc3V0ZHd5YnNhdG14dXlqemZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczMzIzMDUsImV4cCI6MjA4MjkwODMwNX0.5i4gAiUVqZ9939-wM43iEDxG4cHQatiju3cL8bxtAMM';
        const sb = supabase.createClient(SB_URL, SB_KEY);
        let user = null, allProfiles = [], selectedMsg = null, isEditing = false;

        window.onload = () => {
            const saved = localStorage.getItem('zy_session');
            if (saved) { user = JSON.parse(saved); enterApp(); }
        };

        async function handleLogin() {
            const n = document.getElementById('u-name').value.trim();
            const p = document.getElementById('u-pass').value.trim();
            const { data } = await sb.from('profiles').select('*').ilike('username', n).eq('password', p).single();
            if (data) {
                user = { name: data.username, color: data.color, role: data.username === 'admin10783' ? 'admin' : 'user' };
                localStorage.setItem('zy_session', JSON.stringify(user));
                enterApp();
            }
        }

        async function enterApp() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('chat-page').classList.remove('hidden');
            const { data } = await sb.from('profiles').select('username, color');
            allProfiles = data;
            loadMsgs();
            listen();
        }

        async function loadMsgs() {
            const { data } = await sb.from('messages').select('*').order('created_at', { ascending: true });
            if (data) render(data);
        }

        function render(data) {
            const box = document.getElementById('msg-box');
            box.innerHTML = data.map(m => {
                const p = allProfiles.find(ap => ap.username === m.sender);
                return `
                <div class="msg-item p-1 px-4 flex flex-col group" oncontextmenu="showMenu(event, ${m.id}, '${m.sender}', \`${m.content}\`)">
                    <div class="flex items-center gap-2">
                        <span class="font-semibold text-sm ${p?.color || 'text-white'}">${m.sender}</span>
                        <span class="text-[10px] text-gray-500">${new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                    </div>
                    <div class="text-sm text-gray-300 ml-0">${m.content}</div>
                </div>`;
            }).join('');
            if(!isEditing) document.getElementById('msg-container').scrollTop = document.getElementById('msg-container').scrollHeight;
        }

        // --- DISCORD CONTEXT MENU ---
        function showMenu(e, id, sender, content) {
            e.preventDefault();
            if (sender !== user.name && user.role !== 'admin') return;
            selectedMsg = { id, content };
            const menu = document.getElementById('context-menu');
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        }

        document.onclick = () => document.getElementById('context-menu').style.display = 'none';

        function startEdit() {
            isEditing = true;
            const input = document.getElementById('msg-input');
            input.value = selectedMsg.content;
            input.focus();
            document.getElementById('edit-info').classList.remove('hidden');
        }

        async function confirmDelete() {
            if(confirm("Delete Message?")) await sb.from('messages').delete().eq('id', selectedMsg.id);
        }

        function cancelEdit() {
            isEditing = false;
            document.getElementById('msg-input').value = '';
            document.getElementById('edit-info').classList.add('hidden');
        }

        // --- KEYBOARD SHORTCUTS ---
        document.getElementById('msg-input').onkeydown = async (e) => {
            if (e.key === 'Enter') {
                const val = e.target.value.trim();
                if (!val) return;
                if (isEditing) {
                    await sb.from('messages').update({ content: val }).eq('id', selectedMsg.id);
                    cancelEdit();
                } else {
                    await sb.from('messages').insert([{ sender: user.name, content: val, receiver: 'all' }]);
                    e.target.value = '';
                }
            }
            // UP ARROW TO EDIT LAST MESSAGE
            if (e.key === 'ArrowUp' && e.target.value === '') {
                const myMsgs = Array.from(document.querySelectorAll('.msg-item'));
                // Logic to find last message and trigger edit (simplified)
                alert("Use Right-Click to Edit for now, Up-Arrow logic syncing...");
            }
            if (e.key === 'Escape') cancelEdit();
        };

        function listen() { sb.channel('zy').on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, loadMsgs).subscribe(); }
    </script>
</body>
</html>
