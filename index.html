<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zychat | System Active</title>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
</head>
<body style="background:#0b0e11; color:white; font-family:sans-serif; display:flex; align-items:center; justify-content:center; height:100vh; margin:0;">
    <div style="background:#15191c; padding:40px; border-radius:20px; text-align:center; border:1px solid #2d333b; width:320px;">
        <h2 style="color:#5865F2; margin:0;">Zychat</h2>
        <p style="font-size:10px; color:#555; margin-bottom:20px;">FCM CONNECTION: ACTIVE</p>
        
        <div id="status-box" style="padding:15px; border-radius:10px; background:#222; margin:20px 0; font-weight:bold; font-size:14px;">
            WAITING FOR BROWSER...
        </div>

        <button onclick="subscribeUser()" style="background:#5865F2; color:white; border:none; padding:15px; border-radius:8px; width:100%; font-weight:bold; cursor:pointer;">
            ACTIVATE NOW
        </button>
        <p id="debug-log" style="font-size:10px; color:#888; margin-top:15px; font-family:monospace;"></p>
    </div>

    <script>
        window.OneSignalDeferred = window.OneSignalDeferred || [];

OneSignalDeferred.push(async function(OneSignal) {
    // Explicitly define the GitHub Pages subfolder
    const folder = '/Zychat/'; 

    await OneSignal.init({
        appId: "ca79f9f6-e0fb-4c7e-b94c-cce09002ea00",
        safari_web_id: "web.onesignal.auto.0640d2f0-7856-4c2f-b485-6187b4b1a20c",
        
        // Use ABSOLUTE paths to avoid "Registration failed"
        serviceWorkerPath: 'OneSignalSDKWorker.js', 
        serviceWorkerParam: { scope: folder },
        
        // This ensures the SDK looks in the right folder for the script
        notificationServiceWorkerPath: 'OneSignalSDKWorker.js',
        notificationServiceWorkerParam: { scope: folder }
    });

    const checkStatus = async () => {
        const id = OneSignal.User.PushSubscription.id;
        const statusBox = document.getElementById('status-box');
        
        if (id) {
            statusBox.style.background = "#238636";
            statusBox.innerText = "✅ SYSTEM ONLINE";
            document.getElementById('id-text').innerText = "ID: " + id;
        } else {
            // Xiaomi/MIUI Force Trigger
            const perm = await OneSignal.Notifications.permission;
            if (perm) {
                statusBox.style.background = "#d29922";
                statusBox.innerText = "⚠️ SYNCING WITH GOOGLE...";
                await OneSignal.User.PushSubscription.optIn();
            } else {
                statusBox.style.background = "#da3633";
                statusBox.innerText = "❌ CLICK ACTIVATE";
            }
        }
    };

    checkStatus();
    setInterval(checkStatus, 3000);
});
    </script>
</body>
</html>
