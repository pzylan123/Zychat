<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zychat | System Fix</title>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
</head>
<body style="background:#0b0e11; color:white; font-family:sans-serif; display:flex; align-items:center; justify-content:center; height:100vh; margin:0;">

    <div style="background:#15191c; padding:40px; border-radius:20px; text-align:center; border:1px solid #2d333b; width:320px;">
        <h2 style="color:#5865F2;">Zychat Push</h2>
        
        <div id="status-box" style="padding:15px; border-radius:10px; background:#222; margin:20px 0; font-weight:bold; font-size:14px;">
            SYSTEM: INITIALIZING...
        </div>

        <p id="id-text" style="font-family:monospace; font-size:10px; color:#888; word-break:break-all;"></p>

        <button onclick="requestPush()" style="background:#5865F2; color:white; border:none; padding:15px; border-radius:8px; width:100%; font-weight:bold; cursor:pointer; margin-top:10px;">
            FIX & ACTIVATE
        </button>
        
        <p style="font-size:11px; color:#555; margin-top:20px;">Redmi Note 7 Pro Fix Applied</p>
    </div>

    <script>
        window.OneSignalDeferred = window.OneSignalDeferred || [];

OneSignalDeferred.push(async function(OneSignal) {
    const repoName = window.location.pathname.split('/')[1]; 
    const isGitHub = window.location.hostname.includes('github.io');
    const finalScope = isGitHub ? `/${repoName}/` : '/';

    try {
        await OneSignal.init({
            appId: "ca79f9f6-e0fb-4c7e-b94c-cce09002ea00",
            safari_web_id: "web.onesignal.auto.0640d2f0-7856-4c2f-b485-6187b4b1a20c",
            serviceWorkerPath: 'OneSignalSDKWorker.js',
            serviceWorkerParam: { scope: finalScope }
        });

        // XIAOMI SPECIFIC: Force a push subscription refresh
        if (await OneSignal.Notifications.permission) {
             console.log("Xiaomi detected - Forcing Background Sync");
             await OneSignal.User.PushSubscription.optIn(); 
        }

        const checkStatus = async () => {
            const id = OneSignal.User.PushSubscription.id;
            const statusBox = document.getElementById('status-box');
            const idText = document.getElementById('id-text');

            if (id) {
                statusBox.style.background = "#238636";
                statusBox.innerText = "✅ GREEN: CONNECTED";
                idText.innerText = "YOUR ID: " + id;
                // Once Green, Discord and Zychat will both work!
            } else {
                statusBox.style.background = "#d29922";
                statusBox.innerText = "⚠️ ORANGE: RE-REGISTERING...";
                // Try to force it every time it's orange
                await OneSignal.User.PushSubscription.optIn();
            }
        };

        checkStatus();
        setInterval(checkStatus, 5000);
    } catch (e) {
        document.getElementById('status-box').innerText = "PATH ERROR";
    }
});
    </script>
</body>
</html>
